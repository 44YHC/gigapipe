// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`log_range_aggregation 1 1`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 300000,
    "idxId": 1,
    "matrix": true,
    "step": 5000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      Raw {
        "raw": "labels",
      },
      "labels",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "toFloat64(count(1)) * 1000 / 300000",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "rate_a",
          "inline": undefined,
          "query": Select {
            "aggregations": [],
            "conditions": Conjunction {
              "args": [
                Condition {
                  "column": Conjunction {
                    "args": [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      In {
                        "column": Term {
                          "term": "samples.type",
                        },
                        "operator": "in",
                        "value": Value {
                          "value": [
                            0,
                            0,
                          ],
                        },
                      },
                    ],
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                Condition {
                  "column": InSubreq {
                    "col": "samples.fingerprint",
                    "raw": undefined,
                    "sub": WithReference {
                      "ref": With {
                        "alias": "idx_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": [],
                          "conditions": Conjunction {
                            "args": [],
                          },
                          "ctx": {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": [],
                          },
                          "joins": [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": [],
                          "params": {},
                          "preconditions": Conjunction {
                            "args": [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": [
                            "sel_1.fingerprint",
                          ],
                          "tables": [
                            [
                              Subquery {
                                "query": Select {
                                  "aggregations": [],
                                  "conditions": Conjunction {
                                    "args": [
                                      Condition {
                                        "column": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Term {
                                                "term": "key",
                                              },
                                              "operator": "=",
                                              "value": Value {
                                                "value": "minus_nam",
                                              },
                                            },
                                            Condition {
                                              "column": Term {
                                                "term": "val",
                                              },
                                              "operator": "=",
                                              "value": Value {
                                                "value": "aut illo",
                                              },
                                            },
                                          ],
                                        },
                                        "operator": undefined,
                                        "value": Value {
                                          "value": undefined,
                                        },
                                      },
                                    ],
                                  },
                                  "ctx": {},
                                  "dist": false,
                                  "fmt": undefined,
                                  "having_conditions": Conjunction {
                                    "args": [],
                                  },
                                  "joins": [],
                                  "limitbycolumns": undefined,
                                  "limits": undefined,
                                  "order_expressions": [],
                                  "params": {},
                                  "preconditions": Conjunction {
                                    "args": [],
                                  },
                                  "request_totals": undefined,
                                  "sampling": undefined,
                                  "select_list": [
                                    "fingerprint",
                                  ],
                                  "tables": [
                                    [
                                      Term {
                                        "term": "loki.time_series_gin",
                                      },
                                    ],
                                  ],
                                  "withs": {},
                                },
                              },
                              Term {
                                "term": "sel_1",
                              },
                            ],
                          ],
                          "withs": {},
                        },
                      },
                    },
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
              ],
            },
            "ctx": {
              "duration": 300000,
              "idxId": 1,
              "matrix": true,
              "step": 5000,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              [
                "timestamp_ns",
                "desc",
              ],
            ],
            "params": {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "isMatrix": Parameter {
                "name": "isMatrix",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_vX",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "timestamp_shift": Parameter {
                "name": "timestamp_shift",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              [
                "samples.string",
                "string",
              ],
              [
                "samples.fingerprint",
                "fingerprint",
              ],
              [
                Raw {
                  "raw": "",
                  "toString": [Function],
                },
                "timestamp_ns",
              ],
            ],
            "tables": [
              [
                Parameter {
                  "name": "samplesTable",
                  "value": "loki.samples_vX",
                },
                Term {
                  "term": "samples",
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "minus_nam",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "aut illo",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "minus_nam",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": {
          "duration": 300000,
          "idxId": 1,
          "matrix": true,
          "step": 5000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 1 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'minus_nam') and (\`val\` = 'aut illo'))) as \`sel_1\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc) select labels as \`labels\`,intDiv(timestamp_ns, 300000) * 300000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc"`;

exports[`log_range_aggregation 2 1`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 300000,
    "idxId": 1,
    "matrix": true,
    "step": 5000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      Raw {
        "raw": "labels",
      },
      "labels",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "toFloat64(count(1)) * 1000 / 300000",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "rate_a",
          "inline": undefined,
          "query": Select {
            "aggregations": [],
            "conditions": Conjunction {
              "args": [
                Condition {
                  "column": Conjunction {
                    "args": [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      In {
                        "column": Term {
                          "term": "samples.type",
                        },
                        "operator": "in",
                        "value": Value {
                          "value": [
                            0,
                            0,
                          ],
                        },
                      },
                    ],
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                Condition {
                  "column": InSubreq {
                    "col": "samples.fingerprint",
                    "raw": undefined,
                    "sub": WithReference {
                      "ref": With {
                        "alias": "idx_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": [],
                          "conditions": Conjunction {
                            "args": [],
                          },
                          "ctx": {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": [],
                          },
                          "joins": [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": [],
                          "params": {},
                          "preconditions": Conjunction {
                            "args": [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": [
                            "sel_1.fingerprint",
                          ],
                          "tables": [
                            [
                              Subquery {
                                "query": Select {
                                  "aggregations": [],
                                  "conditions": Conjunction {
                                    "args": [
                                      Condition {
                                        "column": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Term {
                                                "term": "key",
                                              },
                                              "operator": "=",
                                              "value": Value {
                                                "value": "rerum_laborum",
                                              },
                                            },
                                            Condition {
                                              "column": Match {
                                                "col": "val",
                                                "raw": "",
                                                "re": Value {
                                                  "value": "^con.+q.at[a-z]r",
                                                },
                                              },
                                              "operator": "=",
                                              "value": Value {
                                                "value": 1,
                                              },
                                            },
                                          ],
                                        },
                                        "operator": undefined,
                                        "value": Value {
                                          "value": undefined,
                                        },
                                      },
                                    ],
                                  },
                                  "ctx": {},
                                  "dist": false,
                                  "fmt": undefined,
                                  "having_conditions": Conjunction {
                                    "args": [],
                                  },
                                  "joins": [],
                                  "limitbycolumns": undefined,
                                  "limits": undefined,
                                  "order_expressions": [],
                                  "params": {},
                                  "preconditions": Conjunction {
                                    "args": [],
                                  },
                                  "request_totals": undefined,
                                  "sampling": undefined,
                                  "select_list": [
                                    "fingerprint",
                                  ],
                                  "tables": [
                                    [
                                      Term {
                                        "term": "loki.time_series_gin",
                                      },
                                    ],
                                  ],
                                  "withs": {},
                                },
                              },
                              Term {
                                "term": "sel_1",
                              },
                            ],
                          ],
                          "withs": {},
                        },
                      },
                    },
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "notLike(string, '%consequatur nam soluta%')",
                  },
                  "operator": "=",
                  "value": Value {
                    "value": 1,
                  },
                },
              ],
            },
            "ctx": {
              "duration": 300000,
              "idxId": 1,
              "matrix": true,
              "step": 5000,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              [
                "timestamp_ns",
                "desc",
              ],
            ],
            "params": {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "isMatrix": Parameter {
                "name": "isMatrix",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_vX",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "timestamp_shift": Parameter {
                "name": "timestamp_shift",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              [
                "samples.string",
                "string",
              ],
              [
                "samples.fingerprint",
                "fingerprint",
              ],
              [
                Raw {
                  "raw": "",
                  "toString": [Function],
                },
                "timestamp_ns",
              ],
            ],
            "tables": [
              [
                Parameter {
                  "name": "samplesTable",
                  "value": "loki.samples_vX",
                },
                Term {
                  "term": "samples",
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 1,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "rerum_laborum",
                                          },
                                        },
                                        Condition {
                                          "column": Match {
                                            "col": "val",
                                            "raw": "",
                                            "re": Value {
                                              "value": "^con.+q.at[a-z]r",
                                            },
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Raw {
                "raw": "notLike(string, '%consequatur nam soluta%')",
              },
              "operator": "=",
              "value": Value {
                "value": 1,
              },
            },
          ],
        },
        "ctx": {
          "duration": 300000,
          "idxId": 1,
          "matrix": true,
          "step": 5000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 2 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 1))) as \`sel_1\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (notLike(string, '%consequatur nam soluta%') = 1) order by \`timestamp_ns\` desc) select labels as \`labels\`,intDiv(timestamp_ns, 300000) * 300000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc"`;

exports[`log_range_aggregation 3 1`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 300000,
    "idxId": 1,
    "matrix": true,
    "step": 5000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      Raw {
        "raw": "labels",
      },
      "labels",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "toFloat64(count(1)) * 1000 / 300000",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "rate_a",
          "inline": undefined,
          "query": Select {
            "aggregations": [],
            "conditions": Conjunction {
              "args": [
                Condition {
                  "column": Conjunction {
                    "args": [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      In {
                        "column": Term {
                          "term": "samples.type",
                        },
                        "operator": "in",
                        "value": Value {
                          "value": [
                            0,
                            0,
                          ],
                        },
                      },
                    ],
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                Condition {
                  "column": InSubreq {
                    "col": "samples.fingerprint",
                    "raw": undefined,
                    "sub": WithReference {
                      "ref": With {
                        "alias": "idx_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": [],
                          "conditions": Conjunction {
                            "args": [],
                          },
                          "ctx": {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": [],
                          },
                          "joins": [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": [],
                          "params": {},
                          "preconditions": Conjunction {
                            "args": [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": [
                            "sel_1.fingerprint",
                          ],
                          "tables": [
                            [
                              Subquery {
                                "query": Select {
                                  "aggregations": [],
                                  "conditions": Conjunction {
                                    "args": [
                                      Condition {
                                        "column": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Term {
                                                "term": "key",
                                              },
                                              "operator": "=",
                                              "value": Value {
                                                "value": "et_dolorem",
                                              },
                                            },
                                            Condition {
                                              "column": Term {
                                                "term": "val",
                                              },
                                              "operator": "!=",
                                              "value": Value {
                                                "value": "nemo doloremque",
                                              },
                                            },
                                          ],
                                        },
                                        "operator": undefined,
                                        "value": Value {
                                          "value": undefined,
                                        },
                                      },
                                    ],
                                  },
                                  "ctx": {},
                                  "dist": false,
                                  "fmt": undefined,
                                  "having_conditions": Conjunction {
                                    "args": [],
                                  },
                                  "joins": [],
                                  "limitbycolumns": undefined,
                                  "limits": undefined,
                                  "order_expressions": [],
                                  "params": {},
                                  "preconditions": Conjunction {
                                    "args": [],
                                  },
                                  "request_totals": undefined,
                                  "sampling": undefined,
                                  "select_list": [
                                    "fingerprint",
                                  ],
                                  "tables": [
                                    [
                                      Term {
                                        "term": "loki.time_series_gin",
                                      },
                                    ],
                                  ],
                                  "withs": {},
                                },
                              },
                              Term {
                                "term": "sel_1",
                              },
                            ],
                          ],
                          "withs": {},
                        },
                      },
                    },
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "match(string, '^mol[eE][^ ]+e +voluptatibus')",
                  },
                  "operator": "=",
                  "value": Raw {
                    "raw": "1",
                  },
                },
              ],
            },
            "ctx": {
              "duration": 300000,
              "idxId": 1,
              "matrix": true,
              "step": 5000,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              [
                "timestamp_ns",
                "desc",
              ],
            ],
            "params": {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "isMatrix": Parameter {
                "name": "isMatrix",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_vX",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "timestamp_shift": Parameter {
                "name": "timestamp_shift",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              [
                "samples.string",
                "string",
              ],
              [
                "samples.fingerprint",
                "fingerprint",
              ],
              [
                Raw {
                  "raw": "",
                  "toString": [Function],
                },
                "timestamp_ns",
              ],
            ],
            "tables": [
              [
                Parameter {
                  "name": "samplesTable",
                  "value": "loki.samples_vX",
                },
                Term {
                  "term": "samples",
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "et_dolorem",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "!=",
                            "value": Value {
                              "value": "nemo doloremque",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "et_dolorem",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "!=",
                                          "value": Value {
                                            "value": "nemo doloremque",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Raw {
                "raw": "match(string, '^mol[eE][^ ]+e +voluptatibus')",
              },
              "operator": "=",
              "value": Raw {
                "raw": "1",
              },
            },
          ],
        },
        "ctx": {
          "duration": 300000,
          "idxId": 1,
          "matrix": true,
          "step": 5000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 3 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'et_dolorem') and (\`val\` != 'nemo doloremque'))) as \`sel_1\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (match(string, '^mol[eE][^ ]+e +voluptatibus') = 1) order by \`timestamp_ns\` desc) select labels as \`labels\`,intDiv(timestamp_ns, 300000) * 300000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc"`;

exports[`log_range_aggregation 4 1`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 1000,
    "idxId": 1,
    "matrix": true,
    "step": 5000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    "labels",
    [
      Raw {
        "raw": "intDiv(timestamp_ns, 5000) * 5000",
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      Term {
        "term": "rate_b",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 0,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "rerum_laborum",
                                          },
                                        },
                                        Condition {
                                          "column": Match {
                                            "col": "val",
                                            "raw": "",
                                            "re": Value {
                                              "value": "^con.+q.at[a-z]r",
                                            },
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 0,
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Raw {
                "raw": "match(string, 'cons[eE][^ ]+r nam soluta')",
              },
              "operator": "=",
              "value": Raw {
                "raw": "0",
              },
            },
          ],
        },
        "ctx": {
          "duration": 1000,
          "idxId": 1,
          "matrix": true,
          "step": 5000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "labels",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 1000",
            },
            "value",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "rerum_laborum",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Match {
                                                      "col": "val",
                                                      "raw": "",
                                                      "re": Value {
                                                        "value": "^con.+q.at[a-z]r",
                                                      },
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": 0,
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "match(string, 'cons[eE][^ ]+r nam soluta')",
                        },
                        "operator": "=",
                        "value": Raw {
                          "raw": "0",
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 1000,
                    "idxId": 1,
                    "matrix": true,
                    "step": 5000,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_vX",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_vX",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 4 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 0))) as \`sel_1\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (match(string, 'cons[eE][^ ]+r nam soluta') = 0) order by \`timestamp_ns\` desc), rate_b AS (select labels as \`labels\`,intDiv(timestamp_ns, 1000) * 1000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 1000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc) select \`labels\`,intDiv(timestamp_ns, 5000) * 5000 as \`timestamp_ns\`,argMin(rate_b.value, rate_b.timestamp_ns) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc"`;

exports[`shoud transpile unwrap 1`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 60000,
    "idxId": 1,
    "matrix": true,
    "step": 120000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": null,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 2000,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": null,
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": null,
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": null,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    "labels",
    [
      Raw {
        "raw": "intDiv(timestamp_ns, 120000) * 120000",
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "argMin(uw_rate_b.value, uw_rate_b.timestamp_ns)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "uw_rate_b",
          "inline": undefined,
          "query": Select {
            "aggregations": [
              "labels",
              "timestamp_ns",
            ],
            "conditions": Conjunction {
              "args": [],
            },
            "ctx": {},
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              "labels",
              "timestamp_ns",
            ],
            "params": {},
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              [
                Raw {
                  "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['fmt']) != 0, labels))",
                },
                "labels",
              ],
              [
                Raw {
                  "raw": "SUM(unwrapped) / 60",
                },
                "value",
              ],
              [
                Raw {
                  "raw": "",
                  "toString": [Function],
                },
                "timestamp_ns",
              ],
            ],
            "tables": [
              [
                WithReference {
                  "ref": With {
                    "alias": "uw_rate_a",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [
                          Condition {
                            "column": Conjunction {
                              "args": [
                                Raw {
                                  "raw": "",
                                  "toString": [Function],
                                },
                                In {
                                  "column": Term {
                                    "term": "samples.type",
                                  },
                                  "operator": "in",
                                  "value": Value {
                                    "value": [
                                      0,
                                      0,
                                    ],
                                  },
                                },
                              ],
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                          Condition {
                            "column": InSubreq {
                              "col": "samples.fingerprint",
                              "raw": undefined,
                              "sub": WithReference {
                                "ref": With {
                                  "alias": "idx_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": [],
                                    "conditions": Conjunction {
                                      "args": [],
                                    },
                                    "ctx": {},
                                    "dist": false,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": [],
                                    },
                                    "joins": [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": [],
                                    "params": {},
                                    "preconditions": Conjunction {
                                      "args": [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": [
                                      "sel_1.fingerprint",
                                    ],
                                    "tables": [
                                      [
                                        Subquery {
                                          "query": Select {
                                            "aggregations": [],
                                            "conditions": Conjunction {
                                              "args": [
                                                Condition {
                                                  "column": Conjunction {
                                                    "args": [
                                                      Condition {
                                                        "column": Term {
                                                          "term": "key",
                                                        },
                                                        "operator": "=",
                                                        "value": Value {
                                                          "value": "test_id",
                                                        },
                                                      },
                                                      Condition {
                                                        "column": Term {
                                                          "term": "val",
                                                        },
                                                        "operator": "=",
                                                        "value": Value {
                                                          "value": "0.7857680014573265_json",
                                                        },
                                                      },
                                                    ],
                                                  },
                                                  "operator": undefined,
                                                  "value": Value {
                                                    "value": undefined,
                                                  },
                                                },
                                              ],
                                            },
                                            "ctx": {},
                                            "dist": false,
                                            "fmt": undefined,
                                            "having_conditions": Conjunction {
                                              "args": [],
                                            },
                                            "joins": [],
                                            "limitbycolumns": undefined,
                                            "limits": undefined,
                                            "order_expressions": [],
                                            "params": {},
                                            "preconditions": Conjunction {
                                              "args": [],
                                            },
                                            "request_totals": undefined,
                                            "sampling": undefined,
                                            "select_list": [
                                              "fingerprint",
                                            ],
                                            "tables": [
                                              [
                                                Term {
                                                  "term": "loki.time_series_gin",
                                                },
                                              ],
                                            ],
                                            "withs": {},
                                          },
                                        },
                                        Term {
                                          "term": "sel_1",
                                        },
                                      ],
                                    ],
                                    "withs": {},
                                  },
                                },
                              },
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                          Condition {
                            "column": Conjunction {
                              "args": [
                                Condition {
                                  "column": Raw {
                                    "raw": "arrayExists(x -> x.1 == 'int_lbl', labels)",
                                  },
                                  "operator": "=",
                                  "value": Value {
                                    "value": 1,
                                  },
                                },
                                Condition {
                                  "column": Raw {
                                    "raw": "isNotNull(unwrapped)",
                                  },
                                  "operator": "=",
                                  "value": Value {
                                    "value": 1,
                                  },
                                },
                              ],
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                        ],
                      },
                      "ctx": {
                        "duration": 60000,
                        "idxId": 1,
                        "matrix": true,
                        "step": 120000,
                      },
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [
                        [
                          "timestamp_ns",
                          "desc",
                        ],
                      ],
                      "params": {
                        "from": Parameter {
                          "name": "from",
                          "value": null,
                        },
                        "isMatrix": Parameter {
                          "name": "isMatrix",
                          "value": null,
                        },
                        "limit": Parameter {
                          "name": "limit",
                          "value": 2000,
                        },
                        "samplesTable": Parameter {
                          "name": "samplesTable",
                          "value": null,
                        },
                        "timeSeriesTable": Parameter {
                          "name": "timeSeriesTable",
                          "value": null,
                        },
                        "timestamp_shift": Parameter {
                          "name": "timestamp_shift",
                          "value": null,
                        },
                        "to": Parameter {
                          "name": "to",
                          "value": null,
                        },
                      },
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        [
                          "samples.string",
                          "string",
                        ],
                        [
                          "samples.fingerprint",
                          "fingerprint",
                        ],
                        [
                          Raw {
                            "raw": "",
                            "toString": [Function],
                          },
                          "timestamp_ns",
                        ],
                        [
                          Raw {
                            "raw": "toFloat64OrNull(arrayFirst(x -> x.1 == 'int_lbl', labels).2)",
                          },
                          "unwrapped",
                        ],
                      ],
                      "tables": [
                        [
                          Parameter {
                            "name": "samplesTable",
                            "value": null,
                          },
                          Term {
                            "term": "samples",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "test_id",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "0.7857680014573265_json",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "uw_rate_a": With {
      "alias": "uw_rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "test_id",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "0.7857680014573265_json",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Conjunction {
                "args": [
                  Condition {
                    "column": Raw {
                      "raw": "arrayExists(x -> x.1 == 'int_lbl', labels)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "isNotNull(unwrapped)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": {
          "duration": 60000,
          "idxId": 1,
          "matrix": true,
          "step": 120000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": null,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 2000,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": null,
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": null,
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": null,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "toFloat64OrNull(arrayFirst(x -> x.1 == 'int_lbl', labels).2)",
            },
            "unwrapped",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": null,
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "uw_rate_b": With {
      "alias": "uw_rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          "labels",
          "timestamp_ns",
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['fmt']) != 0, labels))",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "SUM(unwrapped) / 60",
            },
            "value",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "uw_rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "test_id",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Term {
                                                      "term": "val",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "0.7857680014573265_json",
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Condition {
                              "column": Raw {
                                "raw": "arrayExists(x -> x.1 == 'int_lbl', labels)",
                              },
                              "operator": "=",
                              "value": Value {
                                "value": 1,
                              },
                            },
                            Condition {
                              "column": Raw {
                                "raw": "isNotNull(unwrapped)",
                              },
                              "operator": "=",
                              "value": Value {
                                "value": 1,
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 60000,
                    "idxId": 1,
                    "matrix": true,
                    "step": 120000,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": null,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 2000,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": null,
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": null,
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": null,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                    [
                      Raw {
                        "raw": "toFloat64OrNull(arrayFirst(x -> x.1 == 'int_lbl', labels).2)",
                      },
                      "unwrapped",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": null,
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`shoud transpile unwrap 2`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 60000,
    "idxId": 1,
    "matrix": true,
    "step": 120000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": null,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 2000,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": null,
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": null,
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": null,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    "labels",
    [
      Raw {
        "raw": "intDiv(timestamp_ns, 120000) * 120000",
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "argMin(uw_rate_b.value, uw_rate_b.timestamp_ns)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "uw_rate_b",
          "inline": undefined,
          "query": Select {
            "aggregations": [
              "labels",
              "timestamp_ns",
            ],
            "conditions": Conjunction {
              "args": [],
            },
            "ctx": {},
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              "labels",
              "timestamp_ns",
            ],
            "params": {},
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              [
                Raw {
                  "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['fmt']) != 0, arraySort(arrayConcat(arrayFilter(x -> arrayExists(y -> y.1 == x.1, extra_labels) == 0, labels), extra_labels))))",
                },
                "labels",
              ],
              [
                Raw {
                  "raw": "SUM(unwrapped) / 60",
                },
                "value",
              ],
              [
                Raw {
                  "raw": "",
                  "toString": [Function],
                },
                "timestamp_ns",
              ],
            ],
            "tables": [
              [
                WithReference {
                  "ref": With {
                    "alias": "uw_rate_a",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [
                          Condition {
                            "column": Conjunction {
                              "args": [
                                Raw {
                                  "raw": "",
                                  "toString": [Function],
                                },
                                In {
                                  "column": Term {
                                    "term": "samples.type",
                                  },
                                  "operator": "in",
                                  "value": Value {
                                    "value": [
                                      0,
                                      0,
                                    ],
                                  },
                                },
                              ],
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                          Condition {
                            "column": InSubreq {
                              "col": "samples.fingerprint",
                              "raw": undefined,
                              "sub": WithReference {
                                "ref": With {
                                  "alias": "idx_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": [],
                                    "conditions": Conjunction {
                                      "args": [],
                                    },
                                    "ctx": {},
                                    "dist": false,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": [],
                                    },
                                    "joins": [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": [],
                                    "params": {},
                                    "preconditions": Conjunction {
                                      "args": [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": [
                                      "sel_1.fingerprint",
                                    ],
                                    "tables": [
                                      [
                                        Subquery {
                                          "query": Select {
                                            "aggregations": [],
                                            "conditions": Conjunction {
                                              "args": [
                                                Condition {
                                                  "column": Conjunction {
                                                    "args": [
                                                      Condition {
                                                        "column": Term {
                                                          "term": "key",
                                                        },
                                                        "operator": "=",
                                                        "value": Value {
                                                          "value": "test_id",
                                                        },
                                                      },
                                                      Condition {
                                                        "column": Term {
                                                          "term": "val",
                                                        },
                                                        "operator": "=",
                                                        "value": Value {
                                                          "value": "0.7857680014573265_json",
                                                        },
                                                      },
                                                    ],
                                                  },
                                                  "operator": undefined,
                                                  "value": Value {
                                                    "value": undefined,
                                                  },
                                                },
                                              ],
                                            },
                                            "ctx": {},
                                            "dist": false,
                                            "fmt": undefined,
                                            "having_conditions": Conjunction {
                                              "args": [],
                                            },
                                            "joins": [],
                                            "limitbycolumns": undefined,
                                            "limits": undefined,
                                            "order_expressions": [],
                                            "params": {},
                                            "preconditions": Conjunction {
                                              "args": [],
                                            },
                                            "request_totals": undefined,
                                            "sampling": undefined,
                                            "select_list": [
                                              "fingerprint",
                                            ],
                                            "tables": [
                                              [
                                                Term {
                                                  "term": "loki.time_series_gin",
                                                },
                                              ],
                                            ],
                                            "withs": {},
                                          },
                                        },
                                        Term {
                                          "term": "sel_1",
                                        },
                                      ],
                                    ],
                                    "withs": {},
                                  },
                                },
                              },
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                          Condition {
                            "column": Raw {
                              "raw": "isValidJSON(samples.string)",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 1,
                            },
                          },
                          Condition {
                            "column": Conjunction {
                              "args": [
                                Disjunction {
                                  "args": [
                                    Condition {
                                      "column": Raw {
                                        "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl2', extra_labels)",
                                      },
                                      "operator": "!=",
                                      "value": Value {
                                        "value": 0,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "arrayExists(x -> x.1 == 'int_lbl2', labels)",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                  ],
                                },
                                Condition {
                                  "column": Raw {
                                    "raw": "isNotNull(unwrapped)",
                                  },
                                  "operator": "=",
                                  "value": Value {
                                    "value": 1,
                                  },
                                },
                              ],
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                        ],
                      },
                      "ctx": {
                        "duration": 60000,
                        "idxId": 1,
                        "matrix": true,
                        "step": 120000,
                      },
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [
                        [
                          "timestamp_ns",
                          "desc",
                        ],
                      ],
                      "params": {
                        "from": Parameter {
                          "name": "from",
                          "value": null,
                        },
                        "isMatrix": Parameter {
                          "name": "isMatrix",
                          "value": null,
                        },
                        "limit": Parameter {
                          "name": "limit",
                          "value": 2000,
                        },
                        "samplesTable": Parameter {
                          "name": "samplesTable",
                          "value": null,
                        },
                        "timeSeriesTable": Parameter {
                          "name": "timeSeriesTable",
                          "value": null,
                        },
                        "timestamp_shift": Parameter {
                          "name": "timestamp_shift",
                          "value": null,
                        },
                        "to": Parameter {
                          "name": "to",
                          "value": null,
                        },
                      },
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        [
                          "samples.string",
                          "string",
                        ],
                        [
                          "samples.fingerprint",
                          "fingerprint",
                        ],
                        [
                          Raw {
                            "raw": "",
                            "toString": [Function],
                          },
                          "timestamp_ns",
                        ],
                        [
                          Raw {
                            "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
                          },
                          "extra_labels",
                        ],
                        [
                          Raw {
                            "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl2', extra_labels), arrayFirst(x -> x.1 == 'int_lbl2', extra_labels).2, arrayFirst(x -> x.1 == 'int_lbl2', labels).2))",
                          },
                          "unwrapped",
                        ],
                      ],
                      "tables": [
                        [
                          Parameter {
                            "name": "samplesTable",
                            "value": null,
                          },
                          Term {
                            "term": "samples",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "test_id",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "0.7857680014573265_json",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "uw_rate_a": With {
      "alias": "uw_rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "test_id",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "0.7857680014573265_json",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Raw {
                "raw": "isValidJSON(samples.string)",
              },
              "operator": "=",
              "value": Value {
                "value": 1,
              },
            },
            Condition {
              "column": Conjunction {
                "args": [
                  Disjunction {
                    "args": [
                      Condition {
                        "column": Raw {
                          "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl2', extra_labels)",
                        },
                        "operator": "!=",
                        "value": Value {
                          "value": 0,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "arrayExists(x -> x.1 == 'int_lbl2', labels)",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                    ],
                  },
                  Condition {
                    "column": Raw {
                      "raw": "isNotNull(unwrapped)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": {
          "duration": 60000,
          "idxId": 1,
          "matrix": true,
          "step": 120000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": null,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 2000,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": null,
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": null,
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": null,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
            },
            "extra_labels",
          ],
          [
            Raw {
              "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl2', extra_labels), arrayFirst(x -> x.1 == 'int_lbl2', extra_labels).2, arrayFirst(x -> x.1 == 'int_lbl2', labels).2))",
            },
            "unwrapped",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": null,
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "uw_rate_b": With {
      "alias": "uw_rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          "labels",
          "timestamp_ns",
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['fmt']) != 0, arraySort(arrayConcat(arrayFilter(x -> arrayExists(y -> y.1 == x.1, extra_labels) == 0, labels), extra_labels))))",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "SUM(unwrapped) / 60",
            },
            "value",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "uw_rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "test_id",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Term {
                                                      "term": "val",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "0.7857680014573265_json",
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "isValidJSON(samples.string)",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Disjunction {
                              "args": [
                                Condition {
                                  "column": Raw {
                                    "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl2', extra_labels)",
                                  },
                                  "operator": "!=",
                                  "value": Value {
                                    "value": 0,
                                  },
                                },
                                Condition {
                                  "column": Raw {
                                    "raw": "arrayExists(x -> x.1 == 'int_lbl2', labels)",
                                  },
                                  "operator": "=",
                                  "value": Value {
                                    "value": 1,
                                  },
                                },
                              ],
                            },
                            Condition {
                              "column": Raw {
                                "raw": "isNotNull(unwrapped)",
                              },
                              "operator": "=",
                              "value": Value {
                                "value": 1,
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 60000,
                    "idxId": 1,
                    "matrix": true,
                    "step": 120000,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": null,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 2000,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": null,
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": null,
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": null,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                    [
                      Raw {
                        "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
                      },
                      "extra_labels",
                    ],
                    [
                      Raw {
                        "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl2', extra_labels), arrayFirst(x -> x.1 == 'int_lbl2', extra_labels).2, arrayFirst(x -> x.1 == 'int_lbl2', labels).2))",
                      },
                      "unwrapped",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": null,
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`shoud transpile unwrap 3`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 60000,
    "idxId": 1,
    "matrix": true,
    "step": 120000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    [
      "labels",
      "asc",
    ],
    [
      "timestamp_ns",
      "asc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": null,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 2000,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": null,
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": null,
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": null,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    "labels",
    [
      Raw {
        "raw": "intDiv(timestamp_ns, 120000) * 120000",
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "argMin(uw_rate_b.value, uw_rate_b.timestamp_ns)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "uw_rate_b",
          "inline": undefined,
          "query": Select {
            "aggregations": [
              "labels",
              "timestamp_ns",
            ],
            "conditions": Conjunction {
              "args": [],
            },
            "ctx": {},
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              "labels",
              "timestamp_ns",
            ],
            "params": {},
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              [
                Raw {
                  "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['int_lbl2']) != 0, arraySort(arrayConcat(arrayFilter(x -> arrayExists(y -> y.1 == x.1, extra_labels) == 0, labels), extra_labels))))",
                },
                "labels",
              ],
              [
                Raw {
                  "raw": "SUM(unwrapped) / 60",
                },
                "value",
              ],
              [
                Raw {
                  "raw": "",
                  "toString": [Function],
                },
                "timestamp_ns",
              ],
            ],
            "tables": [
              [
                WithReference {
                  "ref": With {
                    "alias": "uw_rate_a",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [
                          Condition {
                            "column": Conjunction {
                              "args": [
                                Raw {
                                  "raw": "",
                                  "toString": [Function],
                                },
                                In {
                                  "column": Term {
                                    "term": "samples.type",
                                  },
                                  "operator": "in",
                                  "value": Value {
                                    "value": [
                                      0,
                                      0,
                                    ],
                                  },
                                },
                              ],
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                          Condition {
                            "column": InSubreq {
                              "col": "samples.fingerprint",
                              "raw": undefined,
                              "sub": WithReference {
                                "ref": With {
                                  "alias": "idx_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": [],
                                    "conditions": Conjunction {
                                      "args": [],
                                    },
                                    "ctx": {},
                                    "dist": false,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": [],
                                    },
                                    "joins": [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": [],
                                    "params": {},
                                    "preconditions": Conjunction {
                                      "args": [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": [
                                      "sel_1.fingerprint",
                                    ],
                                    "tables": [
                                      [
                                        Subquery {
                                          "query": Select {
                                            "aggregations": [],
                                            "conditions": Conjunction {
                                              "args": [
                                                Condition {
                                                  "column": Conjunction {
                                                    "args": [
                                                      Condition {
                                                        "column": Term {
                                                          "term": "key",
                                                        },
                                                        "operator": "=",
                                                        "value": Value {
                                                          "value": "test_id",
                                                        },
                                                      },
                                                      Condition {
                                                        "column": Term {
                                                          "term": "val",
                                                        },
                                                        "operator": "=",
                                                        "value": Value {
                                                          "value": "0.7857680014573265_json",
                                                        },
                                                      },
                                                    ],
                                                  },
                                                  "operator": undefined,
                                                  "value": Value {
                                                    "value": undefined,
                                                  },
                                                },
                                              ],
                                            },
                                            "ctx": {},
                                            "dist": false,
                                            "fmt": undefined,
                                            "having_conditions": Conjunction {
                                              "args": [],
                                            },
                                            "joins": [],
                                            "limitbycolumns": undefined,
                                            "limits": undefined,
                                            "order_expressions": [],
                                            "params": {},
                                            "preconditions": Conjunction {
                                              "args": [],
                                            },
                                            "request_totals": undefined,
                                            "sampling": undefined,
                                            "select_list": [
                                              "fingerprint",
                                            ],
                                            "tables": [
                                              [
                                                Term {
                                                  "term": "loki.time_series_gin",
                                                },
                                              ],
                                            ],
                                            "withs": {},
                                          },
                                        },
                                        Term {
                                          "term": "sel_1",
                                        },
                                      ],
                                    ],
                                    "withs": {},
                                  },
                                },
                              },
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                          Condition {
                            "column": Raw {
                              "raw": "isValidJSON(samples.string)",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 1,
                            },
                          },
                          Condition {
                            "column": Conjunction {
                              "args": [
                                Disjunction {
                                  "args": [
                                    Condition {
                                      "column": Raw {
                                        "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl', extra_labels)",
                                      },
                                      "operator": "!=",
                                      "value": Value {
                                        "value": 0,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "arrayExists(x -> x.1 == 'int_lbl', labels)",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                  ],
                                },
                                Condition {
                                  "column": Raw {
                                    "raw": "isNotNull(unwrapped)",
                                  },
                                  "operator": "=",
                                  "value": Value {
                                    "value": 1,
                                  },
                                },
                              ],
                            },
                            "operator": undefined,
                            "value": Value {
                              "value": undefined,
                            },
                          },
                        ],
                      },
                      "ctx": {
                        "duration": 60000,
                        "idxId": 1,
                        "matrix": true,
                        "step": 120000,
                      },
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [
                        [
                          "timestamp_ns",
                          "desc",
                        ],
                      ],
                      "params": {
                        "from": Parameter {
                          "name": "from",
                          "value": null,
                        },
                        "isMatrix": Parameter {
                          "name": "isMatrix",
                          "value": null,
                        },
                        "limit": Parameter {
                          "name": "limit",
                          "value": 2000,
                        },
                        "samplesTable": Parameter {
                          "name": "samplesTable",
                          "value": null,
                        },
                        "timeSeriesTable": Parameter {
                          "name": "timeSeriesTable",
                          "value": null,
                        },
                        "timestamp_shift": Parameter {
                          "name": "timestamp_shift",
                          "value": null,
                        },
                        "to": Parameter {
                          "name": "to",
                          "value": null,
                        },
                      },
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        [
                          "samples.string",
                          "string",
                        ],
                        [
                          "samples.fingerprint",
                          "fingerprint",
                        ],
                        [
                          Raw {
                            "raw": "",
                            "toString": [Function],
                          },
                          "timestamp_ns",
                        ],
                        [
                          Raw {
                            "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
                          },
                          "extra_labels",
                        ],
                        [
                          Raw {
                            "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl', extra_labels), arrayFirst(x -> x.1 == 'int_lbl', extra_labels).2, arrayFirst(x -> x.1 == 'int_lbl', labels).2))",
                          },
                          "unwrapped",
                        ],
                      ],
                      "tables": [
                        [
                          Parameter {
                            "name": "samplesTable",
                            "value": null,
                          },
                          Term {
                            "term": "samples",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "test_id",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "0.7857680014573265_json",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "uw_rate_a": With {
      "alias": "uw_rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "test_id",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "0.7857680014573265_json",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Raw {
                "raw": "isValidJSON(samples.string)",
              },
              "operator": "=",
              "value": Value {
                "value": 1,
              },
            },
            Condition {
              "column": Conjunction {
                "args": [
                  Disjunction {
                    "args": [
                      Condition {
                        "column": Raw {
                          "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl', extra_labels)",
                        },
                        "operator": "!=",
                        "value": Value {
                          "value": 0,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "arrayExists(x -> x.1 == 'int_lbl', labels)",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                    ],
                  },
                  Condition {
                    "column": Raw {
                      "raw": "isNotNull(unwrapped)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": {
          "duration": 60000,
          "idxId": 1,
          "matrix": true,
          "step": 120000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": null,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 2000,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": null,
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": null,
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": null,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
            },
            "extra_labels",
          ],
          [
            Raw {
              "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl', extra_labels), arrayFirst(x -> x.1 == 'int_lbl', extra_labels).2, arrayFirst(x -> x.1 == 'int_lbl', labels).2))",
            },
            "unwrapped",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": null,
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "uw_rate_b": With {
      "alias": "uw_rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          "labels",
          "timestamp_ns",
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['int_lbl2']) != 0, arraySort(arrayConcat(arrayFilter(x -> arrayExists(y -> y.1 == x.1, extra_labels) == 0, labels), extra_labels))))",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "SUM(unwrapped) / 60",
            },
            "value",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "uw_rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "test_id",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Term {
                                                      "term": "val",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "0.7857680014573265_json",
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "isValidJSON(samples.string)",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Disjunction {
                              "args": [
                                Condition {
                                  "column": Raw {
                                    "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl', extra_labels)",
                                  },
                                  "operator": "!=",
                                  "value": Value {
                                    "value": 0,
                                  },
                                },
                                Condition {
                                  "column": Raw {
                                    "raw": "arrayExists(x -> x.1 == 'int_lbl', labels)",
                                  },
                                  "operator": "=",
                                  "value": Value {
                                    "value": 1,
                                  },
                                },
                              ],
                            },
                            Condition {
                              "column": Raw {
                                "raw": "isNotNull(unwrapped)",
                              },
                              "operator": "=",
                              "value": Value {
                                "value": 1,
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 60000,
                    "idxId": 1,
                    "matrix": true,
                    "step": 120000,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": null,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 2000,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": null,
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": null,
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": null,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                    [
                      Raw {
                        "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
                      },
                      "extra_labels",
                    ],
                    [
                      Raw {
                        "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl', extra_labels), arrayFirst(x -> x.1 == 'int_lbl', extra_labels).2, arrayFirst(x -> x.1 == 'int_lbl', labels).2))",
                      },
                      "unwrapped",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": null,
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 1`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 300000,
    "end": 3600000,
    "idxId": 1,
    "matrix": true,
    "start": 0,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    "labels",
    "timestamp_ns",
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      Raw {
        "raw": "arrayFilter(x -> x.1 IN ('label_1'), labels)",
      },
      "labels",
    ],
    "timestamp_ns",
    [
      Raw {
        "raw": "sum(value)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "agg_a",
          "inline": undefined,
          "query": Select {
            "aggregations": [
              "labels",
              "timestamp_ns",
            ],
            "conditions": Conjunction {
              "args": [],
            },
            "ctx": {
              "duration": 300000,
              "end": 3600000,
              "idxId": 1,
              "matrix": true,
              "start": 0,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              [
                "labels",
                "asc",
              ],
              [
                "timestamp_ns",
                "asc",
              ],
            ],
            "params": {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "isMatrix": Parameter {
                "name": "isMatrix",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_vX",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "timestamp_shift": Parameter {
                "name": "timestamp_shift",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              "labels",
              [
                Raw {
                  "raw": "intDiv(timestamp_ns, undefined) * undefined",
                },
                "timestamp_ns",
              ],
              [
                Raw {
                  "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
                },
                "value",
              ],
            ],
            "tables": [
              [
                Term {
                  "term": "rate_b",
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "agg_a": With {
      "alias": "agg_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {
          "duration": 300000,
          "end": 3600000,
          "idxId": 1,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "labels",
          [
            Raw {
              "raw": "intDiv(timestamp_ns, undefined) * undefined",
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
            },
            "value",
          ],
        ],
        "tables": [
          [
            Term {
              "term": "rate_b",
            },
          ],
        ],
        "withs": {},
      },
    },
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "minus_nam",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "aut illo",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "minus_nam",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": {
          "duration": 300000,
          "end": 3600000,
          "idxId": 1,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "labels",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "minus_nam",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Term {
                                                      "term": "val",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "aut illo",
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 300000,
                    "end": 3600000,
                    "idxId": 1,
                    "matrix": true,
                    "start": 0,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_vX",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_vX",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'minus_nam') and (\`val\` = 'aut illo'))) as \`sel_1\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc), rate_b AS (select labels as \`labels\`,intDiv(timestamp_ns, 300000) * 300000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc), agg_a AS (select \`labels\`,intDiv(timestamp_ns, undefined) * undefined as \`timestamp_ns\`,argMin(rate_b.value, rate_b.timestamp_ns) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc) select arrayFilter(x -> x.1 IN ('label_1'), labels) as \`labels\`,\`timestamp_ns\`,sum(value) as \`value\` from agg_a group by \`labels\`,\`timestamp_ns\` order by \`labels\`,\`timestamp_ns\`"`;

exports[`should transpile aggregation_operator 3`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 300000,
    "end": 3600000,
    "idxId": 2,
    "matrix": true,
    "start": 0,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    "labels",
    "timestamp_ns",
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      Raw {
        "raw": "arrayFilter(x -> x.1 IN ('label_1'), labels)",
      },
      "labels",
    ],
    "timestamp_ns",
    [
      Raw {
        "raw": "sum(value)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "agg_a",
          "inline": undefined,
          "query": Select {
            "aggregations": [
              "labels",
              "timestamp_ns",
            ],
            "conditions": Conjunction {
              "args": [],
            },
            "ctx": {
              "duration": 300000,
              "end": 3600000,
              "idxId": 2,
              "matrix": true,
              "start": 0,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              [
                "labels",
                "asc",
              ],
              [
                "timestamp_ns",
                "asc",
              ],
            ],
            "params": {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "isMatrix": Parameter {
                "name": "isMatrix",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_vX",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "timestamp_shift": Parameter {
                "name": "timestamp_shift",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              "labels",
              [
                Raw {
                  "raw": "intDiv(timestamp_ns, undefined) * undefined",
                },
                "timestamp_ns",
              ],
              [
                Raw {
                  "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
                },
                "value",
              ],
            ],
            "tables": [
              [
                Term {
                  "term": "rate_b",
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "agg_a": With {
      "alias": "agg_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {
          "duration": 300000,
          "end": 3600000,
          "idxId": 2,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "labels",
          [
            Raw {
              "raw": "intDiv(timestamp_ns, undefined) * undefined",
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
            },
            "value",
          ],
        ],
        "tables": [
          [
            Term {
              "term": "rate_b",
            },
          ],
        ],
        "withs": {},
      },
    },
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_2.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 1,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_2",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "fmt": undefined,
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "minus_nam",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_2.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "rerum_laborum",
                                          },
                                        },
                                        Condition {
                                          "column": Match {
                                            "col": "val",
                                            "raw": "",
                                            "re": Value {
                                              "value": "^con.+q.at[a-z]r",
                                            },
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_2",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Raw {
                "raw": "notLike(string, '%consequatur nam soluta%')",
              },
              "operator": "=",
              "value": Value {
                "value": 1,
              },
            },
          ],
        },
        "ctx": {
          "duration": 300000,
          "end": 3600000,
          "idxId": 2,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "labels",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "fmt": undefined,
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "minus_nam",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Term {
                                                      "term": "val",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "aut illo",
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_2.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "rerum_laborum",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Match {
                                                      "col": "val",
                                                      "raw": "",
                                                      "re": Value {
                                                        "value": "^con.+q.at[a-z]r",
                                                      },
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": 1,
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_2",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "notLike(string, '%consequatur nam soluta%')",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 300000,
                    "end": 3600000,
                    "idxId": 2,
                    "matrix": true,
                    "start": 0,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_vX",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_vX",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 4`] = `"WITH idx_sel AS (select \`sel_2\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 1))) as \`sel_2\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (samples.fingerprint IN idx_sel) and (notLike(string, '%consequatur nam soluta%') = 1) order by \`timestamp_ns\` desc), rate_b AS (select labels as \`labels\`,intDiv(timestamp_ns, 300000) * 300000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc), agg_a AS (select \`labels\`,intDiv(timestamp_ns, undefined) * undefined as \`timestamp_ns\`,argMin(rate_b.value, rate_b.timestamp_ns) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc) select arrayFilter(x -> x.1 IN ('label_1'), labels) as \`labels\`,\`timestamp_ns\`,sum(value) as \`value\` from agg_a group by \`labels\`,\`timestamp_ns\` order by \`labels\`,\`timestamp_ns\`"`;

exports[`should transpile aggregation_operator 5`] = `
Select {
  "aggregations": [
    "labels",
    "timestamp_ns",
  ],
  "conditions": Conjunction {
    "args": [],
  },
  "ctx": {
    "duration": 300000,
    "end": 3600000,
    "idxId": 1,
    "matrix": true,
    "start": 0,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": [
    "labels",
    "timestamp_ns",
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "timestamp_shift": Parameter {
      "name": "timestamp_shift",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      Raw {
        "raw": "arrayFilter(x -> x.1 IN ('label_1'), labels)",
      },
      "labels",
    ],
    "timestamp_ns",
    [
      Raw {
        "raw": "sum(value)",
      },
      "value",
    ],
  ],
  "tables": [
    [
      WithReference {
        "ref": With {
          "alias": "agg_a",
          "inline": undefined,
          "query": Select {
            "aggregations": [
              "labels",
              "timestamp_ns",
            ],
            "conditions": Conjunction {
              "args": [],
            },
            "ctx": {
              "duration": 300000,
              "end": 3600000,
              "idxId": 1,
              "matrix": true,
              "start": 0,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": [],
            },
            "joins": [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": [
              [
                "labels",
                "asc",
              ],
              [
                "timestamp_ns",
                "asc",
              ],
            ],
            "params": {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "isMatrix": Parameter {
                "name": "isMatrix",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_vX",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "timestamp_shift": Parameter {
                "name": "timestamp_shift",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": [
              "labels",
              [
                Raw {
                  "raw": "intDiv(timestamp_ns, undefined) * undefined",
                },
                "timestamp_ns",
              ],
              [
                Raw {
                  "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
                },
                "value",
              ],
            ],
            "tables": [
              [
                Term {
                  "term": "rate_b",
                },
              ],
            ],
            "withs": {},
          },
        },
      },
    ],
  ],
  "withs": {
    "agg_a": With {
      "alias": "agg_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {
          "duration": 300000,
          "end": 3600000,
          "idxId": 1,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "labels",
          [
            Raw {
              "raw": "intDiv(timestamp_ns, undefined) * undefined",
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "argMin(rate_b.value, rate_b.timestamp_ns)",
            },
            "value",
          ],
        ],
        "tables": [
          [
            Term {
              "term": "rate_b",
            },
          ],
        ],
        "withs": {},
      },
    },
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "minus_nam",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "aut illo",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [
            Condition {
              "column": Conjunction {
                "args": [
                  Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  In {
                    "column": Term {
                      "term": "samples.type",
                    },
                    "operator": "in",
                    "value": Value {
                      "value": [
                        0,
                        0,
                      ],
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": InSubreq {
                "col": "samples.fingerprint",
                "raw": undefined,
                "sub": WithReference {
                  "ref": With {
                    "alias": "idx_sel",
                    "inline": undefined,
                    "query": Select {
                      "aggregations": [],
                      "conditions": Conjunction {
                        "args": [],
                      },
                      "ctx": {},
                      "dist": false,
                      "fmt": undefined,
                      "having_conditions": Conjunction {
                        "args": [],
                      },
                      "joins": [],
                      "limitbycolumns": undefined,
                      "limits": undefined,
                      "order_expressions": [],
                      "params": {},
                      "preconditions": Conjunction {
                        "args": [],
                      },
                      "request_totals": undefined,
                      "sampling": undefined,
                      "select_list": [
                        "sel_1.fingerprint",
                      ],
                      "tables": [
                        [
                          Subquery {
                            "query": Select {
                              "aggregations": [],
                              "conditions": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Conjunction {
                                      "args": [
                                        Condition {
                                          "column": Term {
                                            "term": "key",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "minus_nam",
                                          },
                                        },
                                        Condition {
                                          "column": Term {
                                            "term": "val",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": {},
                              "dist": false,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": [],
                              },
                              "joins": [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": [],
                              "params": {},
                              "preconditions": Conjunction {
                                "args": [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": [
                                "fingerprint",
                              ],
                              "tables": [
                                [
                                  Term {
                                    "term": "loki.time_series_gin",
                                  },
                                ],
                              ],
                              "withs": {},
                            },
                          },
                          Term {
                            "term": "sel_1",
                          },
                        ],
                      ],
                      "withs": {},
                    },
                  },
                },
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": {
          "duration": 300000,
          "end": 3600000,
          "idxId": 1,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "timestamp_ns",
            "desc",
          ],
        ],
        "params": {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "isMatrix": Parameter {
            "name": "isMatrix",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_vX",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "timestamp_shift": Parameter {
            "name": "timestamp_shift",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            "samples.string",
            "string",
          ],
          [
            "samples.fingerprint",
            "fingerprint",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
        ],
        "tables": [
          [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_vX",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": [
          "labels",
          "timestamp_ns",
        ],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [
          [
            "labels",
            "asc",
          ],
          [
            "timestamp_ns",
            "asc",
          ],
        ],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          [
            Raw {
              "raw": "labels",
            },
            "labels",
          ],
          [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            "timestamp_ns",
          ],
          [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": [
          [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": [],
                  "conditions": Conjunction {
                    "args": [
                      Condition {
                        "column": Conjunction {
                          "args": [
                            Raw {
                              "raw": "",
                              "toString": [Function],
                            },
                            In {
                              "column": Term {
                                "term": "samples.type",
                              },
                              "operator": "in",
                              "value": Value {
                                "value": [
                                  0,
                                  0,
                                ],
                              },
                            },
                          ],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      Condition {
                        "column": InSubreq {
                          "col": "samples.fingerprint",
                          "raw": undefined,
                          "sub": WithReference {
                            "ref": With {
                              "alias": "idx_sel",
                              "inline": undefined,
                              "query": Select {
                                "aggregations": [],
                                "conditions": Conjunction {
                                  "args": [],
                                },
                                "ctx": {},
                                "dist": false,
                                "fmt": undefined,
                                "having_conditions": Conjunction {
                                  "args": [],
                                },
                                "joins": [],
                                "limitbycolumns": undefined,
                                "limits": undefined,
                                "order_expressions": [],
                                "params": {},
                                "preconditions": Conjunction {
                                  "args": [],
                                },
                                "request_totals": undefined,
                                "sampling": undefined,
                                "select_list": [
                                  "sel_1.fingerprint",
                                ],
                                "tables": [
                                  [
                                    Subquery {
                                      "query": Select {
                                        "aggregations": [],
                                        "conditions": Conjunction {
                                          "args": [
                                            Condition {
                                              "column": Conjunction {
                                                "args": [
                                                  Condition {
                                                    "column": Term {
                                                      "term": "key",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "minus_nam",
                                                    },
                                                  },
                                                  Condition {
                                                    "column": Term {
                                                      "term": "val",
                                                    },
                                                    "operator": "=",
                                                    "value": Value {
                                                      "value": "aut illo",
                                                    },
                                                  },
                                                ],
                                              },
                                              "operator": undefined,
                                              "value": Value {
                                                "value": undefined,
                                              },
                                            },
                                          ],
                                        },
                                        "ctx": {},
                                        "dist": false,
                                        "fmt": undefined,
                                        "having_conditions": Conjunction {
                                          "args": [],
                                        },
                                        "joins": [],
                                        "limitbycolumns": undefined,
                                        "limits": undefined,
                                        "order_expressions": [],
                                        "params": {},
                                        "preconditions": Conjunction {
                                          "args": [],
                                        },
                                        "request_totals": undefined,
                                        "sampling": undefined,
                                        "select_list": [
                                          "fingerprint",
                                        ],
                                        "tables": [
                                          [
                                            Term {
                                              "term": "loki.time_series_gin",
                                            },
                                          ],
                                        ],
                                        "withs": {},
                                      },
                                    },
                                    Term {
                                      "term": "sel_1",
                                    },
                                  ],
                                ],
                                "withs": {},
                              },
                            },
                          },
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                    ],
                  },
                  "ctx": {
                    "duration": 300000,
                    "end": 3600000,
                    "idxId": 1,
                    "matrix": true,
                    "start": 0,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": [],
                  },
                  "joins": [],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": [
                    [
                      "timestamp_ns",
                      "desc",
                    ],
                  ],
                  "params": {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "isMatrix": Parameter {
                      "name": "isMatrix",
                      "value": null,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_vX",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "timestamp_shift": Parameter {
                      "name": "timestamp_shift",
                      "value": null,
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": [
                    [
                      "samples.string",
                      "string",
                    ],
                    [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    [
                      Raw {
                        "raw": "",
                        "toString": [Function],
                      },
                      "timestamp_ns",
                    ],
                  ],
                  "tables": [
                    [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_vX",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": {},
                },
              },
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 6`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'minus_nam') and (\`val\` = 'aut illo'))) as \`sel_1\`), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc), rate_b AS (select labels as \`labels\`,intDiv(timestamp_ns, 300000) * 300000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc), agg_a AS (select \`labels\`,intDiv(timestamp_ns, undefined) * undefined as \`timestamp_ns\`,argMin(rate_b.value, rate_b.timestamp_ns) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc) select arrayFilter(x -> x.1 IN ('label_1'), labels) as \`labels\`,\`timestamp_ns\`,sum(value) as \`value\` from agg_a group by \`labels\`,\`timestamp_ns\` order by \`labels\`,\`timestamp_ns\`"`;

exports[`should transpile complex pipelines 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '\${testID}')) and ((JSONHas(labels, 'freq') = 1) and (toFloat64OrNull(JSONExtractString(labels, 'freq')) >= '4'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 0000000 and 100000000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` asc limit 1000) select * from sel_a order by \`labels\` asc,\`timestamp_ns\` asc",
  "stream": [],
}
`;

exports[`should transpile json requests 1`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "autem_quis",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "quidem sit",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": Raw {
          "raw": "isValidJSON(samples.string)",
        },
        "operator": "=",
        "value": Value {
          "value": 1,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
    [
      Raw {
        "raw": "arrayFilter((x) -> x.2 != '', [('odit_iusto', if(JSONType(samples.string, 'dicta') == 'String', JSONExtractString(samples.string, 'dicta'), JSONExtractRaw(samples.string, 'dicta')))])",
      },
      "extra_labels",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "autem_quis",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "quidem sit",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile json requests 2`] = `
[
  {
    "labels": {
      "autem_quis": "quidem sit",
      "l1": "v3",
      "l2": "v2",
      "l3": "v4",
    },
    "string": "{\"l1\":\"v3\",\"l3\":\"v4\"}",
  },
]
`;

exports[`should transpile line format 1`] = `
[
  {
    "labels": {
      "int": 10,
      "lbl1": "a",
    },
    "string": "str a 5",
  },
]
`;

exports[`should transpile line format 2`] = `
[
  {
    "labels": {
      "entry": "str",
      "int": 10,
      "intval": "5",
      "lbl1": "a",
    },
    "string": "{ \"entry\": \"str\", \"intval\": 5 }",
  },
]
`;

exports[`should transpile line format 3`] = `
[
  {
    "labels": {
      "entry": "str",
      "int": 10,
      "intval": "5",
      "lbl1": "a",
    },
    "timestamp_ns": "0",
    "value": 5,
  },
  {
    "EOF": true,
  },
]
`;

exports[`should transpile log_stream_selector 1`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [
                  {
                    "conditions": [
                      Condition {
                        "column": Term {
                          "term": "sel_1.fingerprint",
                        },
                        "operator": "=",
                        "value": Term {
                          "term": "sel_2.fingerprint",
                        },
                      },
                    ],
                    "table": AliasedSelect {
                      "alias": Term {
                        "term": "sel_2",
                      },
                      "sel": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "quia",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "eum voluptatem non eligendi",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    "type": " inner any ",
                  },
                ],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "et_dolorem",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "nemo doloremque",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 2,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [
          {
            "conditions": [
              Condition {
                "column": Term {
                  "term": "sel_1.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "sel_2.fingerprint",
                },
              },
            ],
            "table": AliasedSelect {
              "alias": Term {
                "term": "sel_2",
              },
              "sel": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "quia",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "eum voluptatem non eligendi",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            "type": " inner any ",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "et_dolorem",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "nemo doloremque",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'et_dolorem') and (\`val\` = 'nemo doloremque'))) as \`sel_1\`  inner any  join (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'quia') and (\`val\` = 'eum voluptatem non eligendi'))) as \`sel_2\` on \`sel_1\`.\`fingerprint\` = \`sel_2\`.\`fingerprint\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector 3`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "rerum_laborum",
                                    },
                                  },
                                  Condition {
                                    "column": Match {
                                      "col": "val",
                                      "raw": "",
                                      "re": Value {
                                        "value": "^con.+q.at[a-z]r",
                                      },
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 1,
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 1,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 4`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 1))) as \`sel_1\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector 5`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "et_dolorem",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "!=",
                                    "value": Value {
                                      "value": "nemo doloremque",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "et_dolorem",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "!=",
                            "value": Value {
                              "value": "nemo doloremque",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 6`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'et_dolorem') and (\`val\` != 'nemo doloremque'))) as \`sel_1\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector 7`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "rerum_laborum",
                                    },
                                  },
                                  Condition {
                                    "column": Match {
                                      "col": "val",
                                      "raw": "",
                                      "re": Value {
                                        "value": "^con.+q.at[a-z]r",
                                      },
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 0,
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 0,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 8`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 0))) as \`sel_1\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 1`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [
                  {
                    "conditions": [
                      Condition {
                        "column": Term {
                          "term": "sel_1.fingerprint",
                        },
                        "operator": "=",
                        "value": Term {
                          "term": "sel_2.fingerprint",
                        },
                      },
                    ],
                    "table": AliasedSelect {
                      "alias": Term {
                        "term": "sel_2",
                      },
                      "sel": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "quia",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "eum voluptatem non eligendi",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    "type": " inner any ",
                  },
                ],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "et_dolorem",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "nemo doloremque",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": Raw {
          "raw": "like(string, '%at et%')",
        },
        "operator": "!=",
        "value": Value {
          "value": 0,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 2,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [
          {
            "conditions": [
              Condition {
                "column": Term {
                  "term": "sel_1.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "sel_2.fingerprint",
                },
              },
            ],
            "table": AliasedSelect {
              "alias": Term {
                "term": "sel_2",
              },
              "sel": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "quia",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "eum voluptatem non eligendi",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            "type": " inner any ",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "et_dolorem",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "nemo doloremque",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 2`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'et_dolorem') and (\`val\` = 'nemo doloremque'))) as \`sel_1\`  inner any  join (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'quia') and (\`val\` = 'eum voluptatem non eligendi'))) as \`sel_2\` on \`sel_1\`.\`fingerprint\` = \`sel_2\`.\`fingerprint\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (like(string, '%at et%') != 0) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 3`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "rerum_laborum",
                                    },
                                  },
                                  Condition {
                                    "column": Match {
                                      "col": "val",
                                      "raw": "",
                                      "re": Value {
                                        "value": "^con.+q.at[a-z]r",
                                      },
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 1,
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": Raw {
          "raw": "notLike(string, '%consequatur nam soluta%')",
        },
        "operator": "=",
        "value": Value {
          "value": 1,
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 1,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 4`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 1))) as \`sel_1\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (notLike(string, '%consequatur nam soluta%') = 1) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 5`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "et_dolorem",
                                    },
                                  },
                                  Condition {
                                    "column": Term {
                                      "term": "val",
                                    },
                                    "operator": "!=",
                                    "value": Value {
                                      "value": "nemo doloremque",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": Raw {
          "raw": "match(string, '^mol[eE][^ ]+e +voluptatibus')",
        },
        "operator": "=",
        "value": Raw {
          "raw": "1",
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "et_dolorem",
                            },
                          },
                          Condition {
                            "column": Term {
                              "term": "val",
                            },
                            "operator": "!=",
                            "value": Value {
                              "value": "nemo doloremque",
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 6`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'et_dolorem') and (\`val\` != 'nemo doloremque'))) as \`sel_1\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (match(string, '^mol[eE][^ ]+e +voluptatibus') = 1) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 7`] = `
Select {
  "aggregations": [],
  "conditions": Conjunction {
    "args": [
      Condition {
        "column": Conjunction {
          "args": [
            Raw {
              "raw": "",
              "toString": [Function],
            },
            In {
              "column": Term {
                "term": "samples.type",
              },
              "operator": "in",
              "value": Value {
                "value": [
                  0,
                  0,
                ],
              },
            },
          ],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": InSubreq {
          "col": "samples.fingerprint",
          "raw": undefined,
          "sub": WithReference {
            "ref": With {
              "alias": "idx_sel",
              "inline": undefined,
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "sel_1.fingerprint",
                ],
                "tables": [
                  [
                    Subquery {
                      "query": Select {
                        "aggregations": [],
                        "conditions": Conjunction {
                          "args": [
                            Condition {
                              "column": Conjunction {
                                "args": [
                                  Condition {
                                    "column": Term {
                                      "term": "key",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "rerum_laborum",
                                    },
                                  },
                                  Condition {
                                    "column": Match {
                                      "col": "val",
                                      "raw": "",
                                      "re": Value {
                                        "value": "^con.+q.at[a-z]r",
                                      },
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 0,
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": {},
                        "dist": false,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": [],
                        },
                        "joins": [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": [],
                        "params": {},
                        "preconditions": Conjunction {
                          "args": [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": [
                          "fingerprint",
                        ],
                        "tables": [
                          [
                            Term {
                              "term": "loki.time_series_gin",
                            },
                          ],
                        ],
                        "withs": {},
                      },
                    },
                    Term {
                      "term": "sel_1",
                    },
                  ],
                ],
                "withs": {},
              },
            },
          },
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      Condition {
        "column": Raw {
          "raw": "match(string, 'cons[eE][^ ]+r nam soluta')",
        },
        "operator": "=",
        "value": Raw {
          "raw": "0",
        },
      },
    ],
  },
  "ctx": {
    "idxId": 1,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": [],
  },
  "joins": [],
  "limitbycolumns": undefined,
  "limits": {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": [
    [
      "timestamp_ns",
      "desc",
    ],
  ],
  "params": {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "isMatrix": Parameter {
      "name": "isMatrix",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_vX",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": [
    [
      "samples.string",
      "string",
    ],
    [
      "samples.fingerprint",
      "fingerprint",
    ],
    [
      Raw {
        "raw": "",
        "toString": [Function],
      },
      "timestamp_ns",
    ],
  ],
  "tables": [
    [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_vX",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": {
    "idx_sel": With {
      "alias": "idx_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": [],
        "conditions": Conjunction {
          "args": [],
        },
        "ctx": {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": [],
        },
        "joins": [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": [],
        "params": {},
        "preconditions": Conjunction {
          "args": [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": [
          "sel_1.fingerprint",
        ],
        "tables": [
          [
            Subquery {
              "query": Select {
                "aggregations": [],
                "conditions": Conjunction {
                  "args": [
                    Condition {
                      "column": Conjunction {
                        "args": [
                          Condition {
                            "column": Term {
                              "term": "key",
                            },
                            "operator": "=",
                            "value": Value {
                              "value": "rerum_laborum",
                            },
                          },
                          Condition {
                            "column": Match {
                              "col": "val",
                              "raw": "",
                              "re": Value {
                                "value": "^con.+q.at[a-z]r",
                              },
                            },
                            "operator": "=",
                            "value": Value {
                              "value": 0,
                            },
                          },
                        ],
                      },
                      "operator": undefined,
                      "value": Value {
                        "value": undefined,
                      },
                    },
                  ],
                },
                "ctx": {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": [],
                },
                "joins": [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": [],
                "params": {},
                "preconditions": Conjunction {
                  "args": [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": [
                  "fingerprint",
                ],
                "tables": [
                  [
                    Term {
                      "term": "loki.time_series_gin",
                    },
                  ],
                ],
                "withs": {},
              },
            },
            Term {
              "term": "sel_1",
            },
          ],
        ],
        "withs": {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 8`] = `"WITH idx_sel AS (select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'rerum_laborum') and (match(val, '^con.+q.at[a-z]r') = 0))) as \`sel_1\`) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1 and 2) and (\`samples\`.\`type\` in (0,0))) and (samples.fingerprint IN idx_sel) and (match(string, 'cons[eE][^ ]+r nam soluta') = 0) order by \`timestamp_ns\` desc limit 3"`;

exports[`should transpile logfmt requests 1`] = `
[
  {
    "labels": {
      "autem_quis": "quidem sit",
      "l1": "v3",
      "l2": "v2",
      "l3": "v4",
    },
    "string": "l1=\"v3\" l3=\"v4\" ",
  },
]
`;

exports[`should transpile new style 1 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7387779420506657'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` desc limit 2000) select JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\`,sel_a.* from sel_a left any join \`loki\`.\`time_series\` AS time_series on \`sel_a\`.\`fingerprint\` = time_series.fingerprint order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [],
}
`;

exports[`should transpile new style 2 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.2119268970232')) and ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '2'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\` from loki.samples_vX as \`samples\` where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (match(string, '2[0-9]$') = 1) order by \`timestamp_ns\` desc limit 2000) select JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\`,sel_a.* from sel_a left any join \`loki\`.\`time_series\` AS time_series on \`sel_a\`.\`fingerprint\` = time_series.fingerprint order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [],
}
`;

exports[`should transpile new style 3 1`] = `
{
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7026038163617259')) and ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '2'))), rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,intDiv(samples.timestamp_ns, 1000000) as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (match(string, '2[0-9]$') = 1) order by \`timestamp_ns\` desc), rate_b AS (select labels as \`labels\`,intDiv(timestamp_ns, 1000) * 1000 as \`timestamp_ns\`,toFloat64(count(1)) * 1000 / 1000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc) select \`labels\`,intDiv(timestamp_ns, 2000) * 2000 as \`timestamp_ns\`,argMin(rate_b.value, rate_b.timestamp_ns) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc",
  "stream": [],
}
`;

exports[`should transpile new style 4 1`] = `
{
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7026038163617259')) and ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '2'))) select \`labels\`,toUInt64(intDiv(timestamp_ns, 1000000000) * 1000) as \`timestamp_ns\`,toFloat64(0) as \`value\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (match(string, '2[0-9]$') = 1) group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc",
  "stream": [
    [Function],
  ],
}
`;

exports[`should transpile new style 5 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.000341166036469831_json'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [
    [Function],
  ],
}
`;

exports[`should transpile new style 6 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.2053747382122484_json'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\`,arrayFilter((x) -> x.2 != '', [('lbl_repl', if(JSONType(samples.string, 'new_lbl') == 'String', JSONExtractString(samples.string, 'new_lbl'), JSONExtractRaw(samples.string, 'new_lbl')))]) as \`extra_labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (isValidJSON(samples.string) = 1) and ((indexOf(extra_labels, ('lbl_repl', 'new_val')) > 0) or ((arrayExists(x -> x.1 == 'lbl_repl', extra_labels) = 0) and ((arrayExists(x -> x.1 == 'lbl_repl', labels) = 1) and (arrayFirst(x -> x.1 == 'lbl_repl', labels).2 = 'new_val')))) order by \`timestamp_ns\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [],
}
`;

exports[`should transpile new style 7 1`] = `
{
  "duration": 3000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.1547558751138609_json'))) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,intDiv(samples.timestamp_ns, 1000000) as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` desc",
  "stream": [
    [Function],
    [Function],
    [Function],
    [Function],
    [Function],
    [Function],
  ],
}
`;

exports[`should transpile new style 8 1`] = `
{
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.4075242197275857'))) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,intDiv(samples.timestamp_ns, 1000000) as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` desc",
  "stream": [
    [Function],
    [Function],
    [Function],
    [Function],
    [Function],
    [Function],
  ],
}
`;

exports[`should transpile new style 9 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7186063017626447_json'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\`,arrayFilter((x) -> x.2 != '', [('sid', if(JSONType(samples.string, 'str_id') == 'String', JSONExtractString(samples.string, 'str_id'), JSONExtractRaw(samples.string, 'str_id')))]) as \`extra_labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (isValidJSON(samples.string) = 1) and ((arrayExists(x -> x.1 == 'sid' AND (coalesce(toFloat64OrNull(x.2) >= '598', 0)), extra_labels) != 0) or ((arrayExists(x -> x.1 == 'sid', extra_labels) = 0) and (arrayExists(x -> x.1 == 'sid', labels) = 1) and (toFloat64OrNull(arrayFirst(x -> x.1 == 'sid', labels).2) >= '598'))) order by \`timestamp_ns\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [],
}
`;

exports[`should transpile new style 10 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.5505504081219323'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\`,arrayFilter(x -> x.1 != '' AND x.2 != '', arrayZip(['e'], arrayMap(x -> x[length(x)], extractAllGroupsHorizontal(string, '^([^0-9]+)[0-9]+$')))) as \`extra_labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [],
}
`;

exports[`should transpile new style 11 1`] = `
{
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'label') = 1) and (JSONExtractString(labels, 'label') = 'val'))), uw_rate_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,intDiv(samples.timestamp_ns, 1000000) as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\`,toFloat64OrNull(arrayFirst(x -> x.1 == 'b', labels).2) as \`unwrapped\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and ((arrayExists(x -> x.1 == 'b', labels) = 1) and (isNotNull(unwrapped) = 1)) order by \`timestamp_ns\` desc), uw_rate_b AS (select labels as \`labels\`,SUM(unwrapped) / 1 as \`value\`,intDiv(timestamp_ns, 1000) * 1000 as \`timestamp_ns\` from uw_rate_a group by \`labels\`,\`timestamp_ns\` order by \`labels\`,\`timestamp_ns\`) select \`labels\`,intDiv(timestamp_ns, 2000) * 2000 as \`timestamp_ns\`,argMin(uw_rate_b.value, uw_rate_b.timestamp_ns) as \`value\` from uw_rate_b group by \`labels\`,\`timestamp_ns\` order by \`labels\` asc,\`timestamp_ns\` asc",
  "stream": [],
}
`;

exports[`should transpile new style 12 1`] = `
{
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '1'))), sel_a AS (select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_vX as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\`   between 1638802620000000000 and 1638803220000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ns\` desc",
  "stream": [
    [Function],
    [Function],
  ],
}
`;

exports[`should transpile plugins 1`] = `
[
  {
    "labels": {
      "lbl1": "a",
    },
    "timestamp_ns": "0",
    "value": 10,
  },
  {
    "EOF": true,
  },
]
`;

exports[`should transpile series 1`] = `"WITH idx_sel AS ((select \`sel_1\`.\`fingerprint\` from (select \`fingerprint\` from \`loki\`.\`time_series_gin\` where ((\`key\` = 'test_id') and (\`val\` = '123'))) as \`sel_1\`)) select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where (\`fingerprint\` in (idx_sel)) and (1 == 1)"`;

exports[`should transpile tail 1`] = `
{
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (extractAllGroups(JSONExtractString(labels, 'test_id'), '(_ws)') != '[]'))) select \`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,samples.timestamp_ns as \`timestamp_ns\`,JSONExtractKeysAndValues(time_series.labels, 'String') as \`labels\` from loki.samples_v3 as \`samples\` left any join \`loki\`.\`time_series\` AS time_series on \`samples\`.\`fingerprint\` = time_series.fingerprint where ((\`samples\`.\`timestamp_ns\` > (toUnixTimestamp(now()) - 5) * 1000000000) and (\`samples\`.\`type\` in (0,0))) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ns\` asc",
  "stream": [],
}
`;
